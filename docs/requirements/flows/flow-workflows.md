---
type: flow
version: "5.0"
---

# Flow: Workflows <!-- id: flow_workflows -->

> 标准工作流，定义人机协作的输入处理和流程路由

**执行规范**：[.solodevflow/flows/workflows.md](../../../.solodevflow/flows/workflows.md)

---

## 1. Overview <!-- id: flow_overview -->

### 1.1 Purpose

定义人机协作的标准流程框架：
- 输入分类：识别用户输入类型（咨询/需求/混合）
- 流程路由：将输入路由到对应的处理流程
- 状态管理：跨对话保持上下文
- 不打断原则：临时需求暂存，不中断当前流程

### 1.2 Core Participants

| 角色 | 职责 |
|------|------|
| User | 提供输入（咨询/需求/混合） |
| AI | 分析输入、路由流程、执行交付 |
| state.json | 唯一状态源，保持跨对话上下文 |

---

## 2. Flow Diagram <!-- id: flow_diagram -->

```
┌─────────────────────────────────────────────────────────────┐
│                     Session Start                            │
│  ┌─────────┐    ┌─────────────┐    ┌──────────────────┐     │
│  │ 读取    │ → │ 汇报状态    │ → │ 等待用户指示     │     │
│  │ state   │    │ +临时需求数 │    │                  │     │
│  └─────────┘    └─────────────┘    └──────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                   Input Analysis                             │
│                                                              │
│  ┌─────────────┐                                            │
│  │ 用户输入   │                                            │
│  └──────┬──────┘                                            │
│         ↓                                                    │
│  ┌─────────────┐                                            │
│  │ 分析输入   │ ← 判断：直接执行？咨询？需求？混合？        │
│  └──────┬──────┘                                            │
│         ↓                                                    │
│  ┌──────┴──────┬──────────┬──────────┬──────────┐          │
│  ↓             ↓          ↓          ↓          ↓          │
│ 直接执行    纯咨询    咨询+需求    纯需求      其他        │
│  ↓             ↓          ↓          ↓          ↓          │
│ 立即          │    提取需求→暂存    │      变更/阶段不符   │
│ 执行      咨询流程        ↓      需求流程                   │
│                   └───────┴──────┘                          │
│                           ↓                                 │
│                     咨询交付流程                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Input Analysis Flow <!-- id: flow_input_analysis -->

> 每次接收用户输入，首先进行输入分析

### 3.1 判断逻辑

```
Step 1: 判断输入类型
  ├─ 直接执行：简单明确的操作指令
  │   └─ 简单 bug 修复、快速查询、单步操作
  ├─ 纯咨询：询问"是什么"、"怎么做"、"为什么"
  ├─ 纯需求：描述"想要"、"希望"、"能不能做"
  ├─ 咨询+需求：咨询中夹带需求描述
  └─ 无法判断：向用户澄清

Step 2: 路由到对应流程
  ├─ 直接执行 → 立即执行，不走流程
  ├─ 纯咨询 → 咨询交付流程
  ├─ 咨询+需求 → 提取需求暂存 → 咨询交付流程
  ├─ 纯需求 → 需求交付流程
  └─ 其他 → 对应处理流程（变更/阶段不符）
```

### 3.2 直接执行判断标准

| 类型 | 识别信号 | 示例 |
|------|----------|------|
| **简单 bug 修复** | 明确的代码问题 + 范围清晰 | "修复这个空指针"、"改正拼写错误" |
| **快速查询** | 查看/显示/检查 | "查看这个文件"、"显示 git 日志" |
| **简单操作** | 运行/执行/格式化 | "运行测试"、"格式化代码" |

**关键判断**：
- ✅ 不涉及设计或需求变更
- ✅ 不需要文档更新
- ✅ 单步操作可完成
- ✅ 范围明确、可直接定位

**边界场景**：
- "修复登录问题" → ❌ 不是直接执行（问题不明确，需要先咨询调查）
- "修复 login.js 第 42 行的空指针" → ✅ 直接执行（问题明确）

### 3.3 混合输入处理原则

- **咨询优先**：先回答咨询问题
- **需求暂存**：提取的需求存入 `session.pendingRequirements`
- **不打断**：不中断当前咨询去处理需求
- **自动提示**：咨询回答后，提示有临时需求待处理

---

## 4. Session State Management <!-- id: flow_session_state -->

> 跨对话保持上下文，支持咨询/需求混合场景

### 4.1 状态结构

```json
{
  "session": {
    "mode": "idle | consulting | delivering",
    "context": {
      "topic": "当前主题",
      "relatedFeatures": [],
      "pendingRequirements": []
    }
  }
}
```

### 4.2 模式定义

| 模式 | 说明 | 进入条件 | 退出条件 |
|------|------|----------|----------|
| `idle` | 空闲 | Session 开始 / 任务完成 | 接收到输入 |
| `consulting` | 咨询中 | 纯咨询或咨询+需求 | 隐式/显式结束 |
| `delivering` | 需求交付中 | 纯需求 / 处理临时需求 | 交付完成 |

### 4.3 咨询结束判断

- **隐式结束**：AI 判断用户开始描述纯需求
- **显式结束**：用户说"咨询完了"、"没问题了"
- **Hook 辅助**：`UserPromptSubmit` 注入当前状态，辅助判断

---

## 5. Consulting Delivery Flow <!-- id: flow_consulting -->

> 咨询交付流程：回答产品咨询，支持混合输入

### 5.1 流程步骤

```
[用户输入]
    ↓
[分析是否包含需求成分]
    ↓
   ┌─ 是 → [提取需求] → [存入 pendingRequirements]
   └─ 否 → [继续]
    ↓
[加载 PRD]
    ↓
[识别关联的 Feature/Flow/Capability]
    ↓
[加载相关文档]
    ↓
[生成回答]
    ↓
[检查 pendingRequirements]
    ↓
 ┌─ 有 → 附加提示
 └─ 无 → 等待下一输入
```

### 5.2 核心行为

- 加载 PRD，查询关联内容
- 通过 state.json 的 docPath 定位相关文档
- 回答后检查临时需求，有则提示

> **待细化**：需求提取的具体规则、PRD 关联查询机制

---

## 6. Requirements Delivery Flow <!-- id: flow_requirements -->

> 需求交付流程：处理功能需求

### 6.1 流程步骤

```
[需求输入]
    ↓
[需求清晰度检查]
    ↓
 ┌─ 模糊 → [requirements-expert 澄清] → [返回]
 └─ 清晰 → [继续]
    ↓
[关系分析：扩展/依赖/影响]
    ↓
[确定文档类型：PRD/Feature/Capability/Flow]
    ↓
[调用 /write-* 命令]
    ↓
[等待用户审核]
```

### 6.2 核心原则

- **Document-First**：先更新文档，后写代码
- **关系分析**：新需求与现有 Feature 的关系
- **规范遵循**：使用 /write-* 命令确保符合规范

---

## 7. Pending Requirements Processing <!-- id: flow_pending_requirements -->

> 处理咨询过程中积累的临时需求

### 7.1 触发条件

- 用户说"处理需求"、"看看临时需求"
- 咨询结束后自动提示

### 7.2 处理方式

| 选择 | 动作 |
|------|------|
| 转为正式需求 | → 需求交付流程 |
| 暂时保留 | 保持在 pendingRequirements |
| 丢弃 | 从列表移除 |

---

## 8. Other Flows (Reference) <!-- id: flow_others -->

> 其他流程的简要索引，详细定义待细化

| 流程 | 触发条件 | 核心行为 |
|------|----------|----------|
| **Session Start** | 对话开始 | 读取状态、汇报、等待指示 |
| **Change Impact** | 变更规范/PRD/模板 | 运行影响分析、生成 subtasks |
| **Spark Handling** | 与当前任务无关的想法 | 记录到 spark-box，不打断 |
| **Phase Mismatch** | 输入与当前阶段不符 | 提供选项：切换/暂存/取消 |

---

## 9. Hooks Integration <!-- id: flow_hooks -->

> Claude Code Hooks 配置框架

| Hook 事件 | 用途 |
|-----------|------|
| `SessionStart` | 读取状态、汇报临时需求数量 |
| `UserPromptSubmit` | 注入当前 mode 和 pendingRequirements |
| `PreToolUse` | 阶段检查（待定） |

> **待细化**：具体 Hook 实现

---

## 10. Execution Principles <!-- id: flow_principles -->

### 始终做

- 每次输入 → 先分析输入类型（直接执行？咨询？需求？）
- 直接执行 → 简单 bug/查询/操作，立即执行不走流程
- 咨询+需求 → 提取需求暂存，先回答咨询
- 回答后 → 检查临时需求，有则提示
- 状态更新 → 通过 State CLI，不直接编辑

### 绝不做

- 咨询过程中打断去处理需求
- 跳过输入分析直接执行（除非明确判断为"直接执行"类型）
- 丢失用户的临时需求
- 将复杂问题错判为"直接执行"

---

*Version: v5.1*
*Created: 2024-12-20*
*Updated: 2024-12-24*
*Changes: v5.1 新增"直接执行"路径，支持简单 bug 修复/查询/操作不走流程；v5.0 重构为纯框架文档*
