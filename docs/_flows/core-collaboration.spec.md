---
type: flow-spec
version: "1.0"
---

# Flow: Core Collaboration <!-- id: flow_core_collaboration -->

> 人机协作的核心流程，定义 AI 如何响应用户输入并维护状态

---

## 1. Flow Overview <!-- id: flow_core_collaboration_overview -->

### 1.1 Purpose

定义人机协作的标准流程，确保：
- 关键输入不丢失
- 灵光被捕获但不打断当前任务
- 状态始终可追溯
- 变更有影响分析

### 1.2 Trigger

| 触发方式 | 说明 |
|----------|------|
| 用户输入 | 任何用户消息都触发此流程 |
| Session 开始 | AI 启动时读取状态恢复上下文 |

---

## 2. Participants <!-- id: flow_core_collaboration_participants -->

| Participant | Type | 职责 |
|-------------|------|------|
| User | External | 提供输入、审核、决策 |
| AI | System | 识别输入类型、记录、执行、更新状态 |
| state.json | Feature | 唯一状态源 |
| input-log.md | Feature | 关键输入记录 |
| spark-box.md | Feature | 灵光收集箱 |
| pending-docs.md | Capability | 文档债务追踪 |

---

## 3. Flow Steps <!-- id: flow_core_collaboration_steps -->

### 3.1 Session Start Flow

```
Session 开始
  → AI 读取 .flow/state.json
  → AI 汇报：当前阶段、任务、待处理灵光数
  → 等待用户指示
```

### 3.2 Main Input Flow

```
用户输入
  → AI 识别输入类型
  → 分支处理（见下方）
  → 更新 state.json
  → 输出反馈
```

| Step | 执行者 | 动作 | 输出 |
|------|--------|------|------|
| 1 | AI | 识别输入类型 | 关键输入 / 灵光 / 执行指令 / 普通对话 |
| 2 | AI | 分支处理 | 记录或执行 |
| 3 | AI | 更新状态 | state.json 更新 |
| 4 | AI | 输出反馈 | 总分结构响应 |

### 3.3 Branches

| 输入类型 | 判断标准 | 处理方式 |
|----------|----------|----------|
| **关键输入** | 影响产品方向、设计决策、功能定义 | 记录到 input-log.md，继续处理 |
| **灵光** | 与当前任务无直接关联 | 记录到 spark-box.md，继续当前任务 |
| **执行指令** | 明确的操作请求 | 执行任务，更新状态 |
| **普通对话** | 确认、闲聊 | 直接响应，不记录 |

### 3.4 Change Handling Flow

```
识别到变更请求
  → 影响分析
  → 人类审批
  → 按优先级处理影响项（文档 → 设计 → 代码）
  → 恢复原任务
```

| Step | 执行者 | 动作 | 输出 |
|------|--------|------|------|
| 1 | AI | 生成影响清单 | 文档/代码/依赖影响 |
| 2 | User | 审批影响清单 | 确认/调整/拒绝 |
| 3 | AI | 处理影响项 | 更新文档和代码 |
| 4 | AI | 恢复原任务 | 继续之前的工作 |

### 3.5 Phase Mismatch Handling

当用户输入与当前阶段不符时：

```
识别到阶段不符
  → 说明当前阶段
  → 提供选项：切换阶段 or 记录到灵光收集箱
  → 等待用户决定
```

---

## 4. Acceptance Criteria <!-- id: flow_core_collaboration_acceptance -->

| Item | Verification | Pass Criteria |
|------|--------------|---------------|
| Session 恢复 | 新 Session 开始 | 正确读取并汇报状态 |
| 关键输入识别 | 提供影响产品的输入 | 自动记录到 input-log.md |
| 灵光捕获 | 提供无关想法 | 记录到 spark-box.md，不打断任务 |
| 变更处理 | 请求变更 | 先做影响分析，等待确认 |
| 阶段引导 | 提供不符合阶段的请求 | 提供选项而非直接执行 |

---

## Flow Diagram <!-- id: flow_core_collaboration_diagram -->

```
┌─────────────────────────────────────────────────────────────┐
│                     Session Start                            │
│  ┌─────────┐    ┌─────────────┐    ┌──────────────────┐     │
│  │ 读取    │ → │ 汇报状态    │ → │ 等待用户指示     │     │
│  │ state   │    │             │    │                  │     │
│  └─────────┘    └─────────────┘    └──────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│                     Main Loop                                │
│                                                              │
│  ┌─────────────┐                                            │
│  │ 用户输入   │                                            │
│  └──────┬──────┘                                            │
│         ↓                                                    │
│  ┌─────────────┐                                            │
│  │ 识别类型   │                                            │
│  └──────┬──────┘                                            │
│         ↓                                                    │
│  ┌──────┴──────┬──────────────┬──────────────┐              │
│  ↓             ↓              ↓              ↓              │
│ 关键输入     灵光          执行指令      普通对话          │
│  ↓             ↓              ↓              ↓              │
│ 记录到       记录到        执行任务      直接响应          │
│ input-log   spark-box     更新状态                         │
│  ↓             ↓              ↓              ↓              │
│  └──────┬──────┴──────────────┴──────────────┘              │
│         ↓                                                    │
│  ┌─────────────┐                                            │
│  │ 更新状态   │                                            │
│  └──────┬──────┘                                            │
│         ↓                                                    │
│  ┌─────────────┐                                            │
│  │ 输出反馈   │ → 继续循环                                 │
│  └─────────────┘                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## Constraints <!-- id: flow_core_collaboration_constraints -->

| Type | Constraint | 说明 |
|------|------------|------|
| Consistency | state.json 是唯一状态源 | 不维护其他状态文件 |
| Atomicity | Commit 前清空 pending-docs | 不允许跨 Commit 累积债务 |
| Order | 先文档后代码 | 变更时先更新文档 |

---

*Version: v1.0*
*Created: 2024-12-20*
*Updated: 2024-12-20*
