# SoloDevFlow 2.0 - 协作规范

> 详细机制定义、阶段规则、文件格式规格

本文档是 `CLAUDE.md` 的详细补充，AI 按需读取。

---

## 一、核心理念

### 这是什么

一套**人机协作开发规范**，让1个人借助 Claude Code 完成软件产品的全流程研发。

### 核心原则

| 原则 | 说明 |
|------|------|
| **人主导决策** | 人类负责需求、方向、验收；AI 负责执行、生成 |
| **流程保证质量** | 不是靠 AI 自觉，而是靠流程 + 工具强制 |
| **捕获 > 遗忘** | 人类的每个输入都被捕获，不丢失 |
| **先全局后细节** | 任何输出都是总分结构，先给结论 |

### 解决的核心问题

| 问题 | 解决机制 |
|------|----------|
| 人类注意力分散，灵光一闪会打断当前任务 | **灵光收集箱**：记录灵光，不打断流程 |
| AI 不按流程执行，直接响应字面需求 | **流程上下文**：AI 始终知道当前阶段 |
| 变更影响感知差，只改局部不顾全局 | **影响分析**：变更前先分析影响范围 |
| 文档规范不执行，靠 AI 自觉不可靠 | **工具校验**：关键节点强制校验 |
| 状态信息过载，人类无法阅读 | **结构化状态**：state.json 在 IDE 中可折叠浏览 |
| AI 输出过载，结构混乱 | **输出规范**：强制总分结构 |
| 人类输入没有保存，决策依据丢失 | **输入日志**：捕获所有关键输入 |

---

## 二、流程全景

```
┌─────────────────────────────────────────────────────────────────┐
│                         项目生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   【项目启动】(一次性)                                            │
│     产品PRD + 流程文档                                           │
│     ↓                                                           │
│   【迭代 1】                                                      │
│     需求 ←→ 设计 ←→ 实现 → 验证                                   │
│     ↓        (可回退)                                            │
│   【迭代 2】(迭代1完成后才开始)                                    │
│     需求 ←→ 设计 ←→ 实现 → 验证                                   │
│     ↓                                                           │
│   【迭代 N】...                                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 阶段说明

| 阶段 | 核心活动 | 产出 | 审批 |
|------|----------|------|------|
| **项目启动** | 定义愿景、元原则、路线图 | 产品PRD、流程文档 | 人类审批 |
| **迭代-需求** | 分析需求、定义范围、明确验收标准 | 迭代PRD | 人类审批 |
| **迭代-设计** | 模块拆分、接口定义、技术方案 | 模块文档（可选） | 人类审批 |
| **迭代-实现** | 编码、单元测试 | 代码 | 自动验证 |
| **迭代-验证** | 集成测试、验收测试 | 测试报告 | 人类验收 |

### 回退规则

**阶段可回退**：发现问题时可回退到早期阶段

| 当前阶段 | 回退到 | 触发条件 |
|----------|--------|----------|
| 设计 | 需求 | 需求不完整/矛盾 |
| 实现 | 设计 | 设计不可行 |
| 实现 | 需求 | 需求理解偏差 |
| 验证 | 设计 | 发现设计缺陷 |
| 验证 | 需求 | 需求定义错误 |

**回退时必须**：
1. 记录回退原因到输入日志
2. 更新受影响模块的状态
3. 标记待重做的产出物

---

## 三、核心机制详细定义

### 3.1 输入日志（Input Log）

**目的**：捕获人类所有关键输入，不丢失决策依据

**判断规则**：
```
每次人类输入后，AI 判断：
  这是"关键输入"吗？（需求、决策、反馈、变更）
    ├─ 是 → 记录到输入日志
    └─ 否 → 不记录（闲聊、确认等）
```

**关键输入 vs 普通对话**：

| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 关键输入 | 影响产品方向、设计决策、功能定义 | "登录要支持微信"、"先做A再做B"、"这个方案不行" |
| 普通对话 | 确认、闲聊、操作指令 | "好的"、"继续"、"帮我看看这个文件" |

**AI操作**：读取 `.flow/input-log.md`，按现有格式在表格末尾追加新行

### 3.2 灵光收集箱（Spark Box）

**目的**：捕获灵光一闪，不打断当前流程

**AI行为**：
```
场景：正在做任务A，人类突然提到任务B

  1. 识别这是"灵光"（与当前任务无关的想法）
  2. 记录到灵光收集箱
  3. 告知人类："已记录到灵光收集箱，我们继续任务A"
  4. 继续当前任务

处理时机：当前任务完成后 / 人类主动说"处理灵光" / 阶段切换时回顾
```

**灵光 vs 当前任务延伸**：

| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 灵光 | 与当前迭代/任务无直接关联 | 正在做登录，突然说"以后要加支付" |
| 任务延伸 | 当前任务的细化、补充、调整 | 正在做登录，说"登录后要跳转到首页" |

**AI操作**：读取 `.flow/spark-box.md`，在"待处理"下追加新条目；处理后移到"已处理"

### 3.3 流程上下文（Flow Context）

**目的**：AI 始终知道当前阶段，主动引导而非被动响应

```
AI 始终维护：
  - 当前阶段：项目启动 / 迭代X-需求 / 迭代X-设计 / ...
  - 当前任务：具体在做什么
  - 待处理灵光：有多少未处理

人类用自然语言时，AI 行为：
  1. 理解人类意图
  2. 判断是否符合当前阶段
     ├─ 符合 → 执行
     └─ 不符合 → 引导
        "你说的是调整需求，按流程应该先更新PRD，要现在切换吗？"
```

**符合阶段 vs 不符合阶段**：

| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 符合 | 请求属于当前阶段的正常产出 | 需求阶段讨论功能范围 |
| 不符合 | 请求属于其他阶段的产出 | 需求阶段要求写代码 |

### 3.4 影响分析（Impact Analysis）

**目的**：变更前先分析影响，不遗漏关联

```
触发条件：任何需求/设计变更

AI 行为：
  1. 暂停执行
  2. 分析影响范围
     - 直接影响：哪些文档/代码需要改
     - 间接影响：哪些关联模块受影响
  3. 输出影响报告（总分结构）
  4. 人类确认后再执行
```

**影响报告格式**：
```
【变更】：xxx
【直接影响】：
  - 文档A：需要更新xxx
  - 代码B：需要修改xxx
【间接影响】：
  - 模块C：因为依赖A，需要检查xxx
【建议操作顺序】：1→2→3
```

**局限性说明**：
- 隐式依赖难以发现（反射、动态调用、配置注入等）
- 跨模块副作用可能漏判
- 重要变更必须配合测试验证

### 3.5 状态管理（State Management）

**目的**：人类可读 + AI 可用 + 跨 Session 连续

**唯一数据源**：`.flow/state.json`
- 在 IDE 中节点可折叠，结构清晰
- AI 每次对话开始时主动读取恢复状态
- 不维护额外的状态文件，避免同步负担

**归档层**（迭代2+）：`history/`
- 已完成迭代的归档
- 输入日志归档
- 按需查阅

**跨 Session 状态连续**：
- Claude Code 每次启动是全新上下文
- AI 必须在对话开始时主动读取 `.flow/state.json`
- 读取后汇报当前状态，再继续工作

### 3.6 Pending Docs 机制

**目的**：追踪"实现先行"场景下的文档债务

**触发场景**：
- 实现倒逼设计：实现时发现设计遗漏，先改代码再补文档
- 快速热修复：紧急修复先上线，后补文档

**AI操作**：
- 发现文档债务时，读取 `.flow/pending-docs.md`，按现有格式追加到"待同步"
- Commit 前检查并提醒人类处理
- 处理完成后移到"已同步"

**规则**：
- 这是"借债"机制，不是逃避文档更新的借口
- 必须在当次 Commit 前清空，不允许跨 Commit 累积
- AI 在 Commit 前主动提醒："有 N 条 pending docs 待处理"

### 3.7 输出规范（Output Standards）

**目的**：AI 输出对人类认知友好

```
强制总分结构：

【任何输出都必须】
  1. 先给结论/全局（1-3句话）
  2. 再给要点（列表，不超过7项）
  3. 最后给细节（可折叠/按需展开）

【设计文档】
  - 先架构图/流程图
  - 再模块说明
  - 最后实现细节

【代码输出】
  - 先说改什么、为什么
  - 再给代码
  - 最后说验证方法
```

---

## 四、阶段详细规则

### 4.1 项目启动

| 项目 | 内容 |
|------|------|
| **触发** | 新项目开始 |
| **AI做什么** | 引导人类描述愿景 → 整理成产品PRD → 确认迭代1范围 |
| **产出** | `docs/产品PRD.md` |
| **审批** | 人类确认产品PRD |
| **完成标志** | 产品PRD已审批，迭代1范围已确定 |

**产品PRD内容**：
- 产品愿景（一句话 + 核心价值）
- 产品描述（High Level，非功能清单）
- 路线图（阶段划分）
- 迭代1引用（指向迭代1-PRD）

### 4.2 迭代-需求

| 项目 | 内容 |
|------|------|
| **触发** | 进入新迭代 |
| **AI做什么** | 引导人类明确范围 → 整理功能清单 → 定义验收标准 |
| **产出** | `docs/iterations/迭代X-PRD.md` |
| **审批** | 人类确认迭代PRD |
| **完成标志** | 迭代PRD已审批 |

**迭代PRD内容**：
- 迭代目标（一句话）
- 功能范围（模块/功能清单）
- 验收标准（怎么算完成）
- 依赖说明（依赖哪些已有模块）

### 4.3 迭代-设计

| 项目 | 内容 |
|------|------|
| **触发** | 迭代PRD已审批 |
| **AI做什么** | 技术方案设计 → 模块设计 → 接口定义 |
| **产出** | `docs/iterations/迭代X-设计.md` |
| **审批** | 人类确认设计 |
| **完成标志** | 设计文档已审批 |

**变更触发影响分析**：
- 如果设计时发现PRD问题 → 先输出影响分析 → 人类确认 → 回到需求阶段

### 4.4 迭代-实现

| 项目 | 内容 |
|------|------|
| **触发** | 设计已审批 |
| **AI做什么** | 按设计实现代码 → 编写测试 → 执行测试 |
| **产出** | 代码 + 测试 |
| **验证** | 测试通过（自动） |
| **完成标志** | 所有测试通过 |

**变更触发影响分析**：
- 实现时发现设计问题 → 影响分析 → 人类确认 → 回到设计阶段

### 4.5 迭代-验证

| 项目 | 内容 |
|------|------|
| **触发** | 实现完成，测试通过 |
| **AI做什么** | 整理验收清单 → 协助人类验收 → 记录发布 |
| **产出** | 验收记录 + 版本Tag |
| **验收** | 人类确认验收 |
| **完成标志** | 迭代完成，可开始下一迭代 |

---

## 五、文件格式规格

### 5.1 state.json 结构

```json
{
  "version": "2.0",
  "project": {
    "name": "string, 必填, 项目名称",
    "description": "string, 可选, 项目描述",
    "createdAt": "string, 必填, ISO日期"
  },
  "flow": {
    "phase": "string, 必填, 枚举: project_init | iteration_requirements | iteration_design | iteration_implementation | iteration_verification",
    "status": "string, 必填, 枚举: in_progress | pending_approval | approved | completed",
    "iteration": "number, 必填, 当前迭代号",
    "task": "string, 可选, 当前任务描述"
  },
  "iterations": [
    {
      "id": "number, 必填",
      "name": "string, 必填",
      "status": "string, 必填, 枚举: planning | in_progress | completed",
      "prd": "string, 可选, PRD文件路径"
    }
  ],
  "sparks": [
    {
      "id": "string, 必填",
      "content": "string, 必填",
      "createdAt": "string, 必填",
      "status": "string, 必填, 枚举: pending | processed"
    }
  ],
  "pendingDocs": [
    {
      "id": "string, 必填",
      "type": "string, 必填",
      "file": "string, 必填",
      "description": "string, 必填",
      "createdAt": "string, 必填"
    }
  ],
  "recentChanges": [
    {
      "date": "string, 必填",
      "change": "string, 必填"
    }
  ],
  "lastUpdated": "string, 必填, ISO日期时间"
}
```

**字段说明**：
- `flow.phase`：当前流程阶段
- `flow.status`：当前阶段的状态
- `sparks`：从 spark-box.md 同步的待处理灵光（便于脚本读取）
- `pendingDocs`：从 pending-docs.md 同步的待处理文档债务
- `recentChanges`：最近变更记录（最多保留10条）

### 5.2 input-log.md 格式

```markdown
# 输入日志

> 记录所有关键输入，保留决策依据

| 时间 | 类型 | 阶段 | 内容 | AI归纳 |
|------|------|------|------|--------|
| 12-17 10:00 | 需求 | 迭代1-需求 | "登录要支持微信" | 新增微信登录需求 |
```

**类型枚举**：需求 | 决策 | 反馈 | 变更

### 5.3 spark-box.md 格式

```markdown
# 灵光收集箱

> 捕获灵光一闪，不打断当前任务

## 待处理

- [ ] **2024-12-17**：以后要加支付功能
  - 来源：迭代1需求讨论时提到
  - 优先级：待定

## 已处理

- [x] **2024-12-16**：考虑支持多语言
  - 处理结果：记录到产品PRD路线图
```

### 5.4 pending-docs.md 格式

```markdown
# Pending Docs

> 追踪"实现先行"场景下的文档债务

## 待同步

| 时间 | 变更类型 | 涉及文件 | 变更内容 |
|------|----------|----------|----------|
| 12-17 | 接口变更 | auth模块 | 新增token参数 |

## 已同步

| 时间 | 变更类型 | 涉及文件 | 同步时间 |
|------|----------|----------|----------|
```

---

## 六、AI 主动引导示例

```
当人类输入与当前阶段不符时：

不要：直接执行人类字面要求
要：先说明当前阶段，询问是否切换

示例：
  人类："我想改一下登录的逻辑"

  错误：直接开始改代码

  正确："当前在【迭代1-需求】阶段。
        你说的是修改登录逻辑，这涉及需求变更。
        按流程应该：1.更新PRD → 2.影响分析 → 3.更新设计 → 4.改代码
        要现在开始吗？还是先记录到灵光收集箱？"
```

---

## 七、快速开始

### 新项目

```
1. 人类描述产品想法
2. AI 引导完成产品PRD
3. 人类审批PRD
4. 进入迭代1-需求
```

### 继续工作

```
1. AI 读取 .flow/state.json 恢复状态
2. AI 汇报：当前阶段、进度、待处理灵光
3. 人类决定继续当前任务 or 处理其他
4. 开始工作
```

---

*版本：v1.0*
*创建时间：2024-12-19*
*说明：从 CLAUDE.md 拆分出的详细规范，遵循"渐进式披露"原则*
