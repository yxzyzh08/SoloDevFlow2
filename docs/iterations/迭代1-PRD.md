# 迭代1 - PRD

> 规范定义 + 基础工具

---

## 一、迭代定位

### 这是什么迭代

**迭代1 是"规范从0到1"的迭代**，核心产出是：
- 一套可用的 AI 协作规范（CLAUDE.md）
- 配套的状态文件和模板（.flow/）
- 2个辅助脚本（status + validate）

### 诚实的预期

| 承诺 | 不承诺 |
|------|--------|
| 规范文档完整可读 | AI 100%按规范执行 |
| 模板文件格式正确 | AI 判断永远准确 |
| 脚本可运行无报错 | 流程完美无缺陷 |
| 自举实验有记录 | 自举实验零问题 |

**为什么这样定位**：
- AI 行为依赖 Prompt 引导，不是代码强制
- 规范的一致性需要迭代2的校验工具来保障
- 迭代1 的价值是"建立基线"，迭代2 才是"强化执行"

---

## 二、交付物清单

### 2.1 规范文档

| 交付物 | 路径 | 说明 |
|--------|------|------|
| AI协作规范（精简版） | `CLAUDE.md` | 精简指令（<100行），遵循最佳实践 |
| 协作规范（详细版） | `docs/协作规范.md` | 详细机制定义、阶段规则、文件格式规格 |
| 产品PRD | `docs/产品PRD.md` | 产品愿景、元原则、路线图 |
| 迭代1-PRD | `docs/iterations/迭代1-PRD.md` | 本文档 |

### 2.2 产出物规范

| 交付物 | 路径 | 说明 |
|--------|------|------|
| 需求文档规范 | `docs/specs/需求文档规范.md` | 迭代PRD的结构、内容要素、编写标准 |
| 设计文档规范 | `docs/specs/设计文档规范.md` | 技术设计的结构、内容要素、编写标准 |
| 研发规范 | `docs/specs/研发规范.md` | 代码结构、代码风格、单元测试、集成测试 |
| 测试规范 | `docs/specs/测试规范.md` | E2E测试、性能测试、破坏性测试、健壮测试 |

### 2.3 状态文件和模板

| 交付物 | 路径 | 说明 |
|--------|------|------|
| 状态数据 | `.flow/state.json` | 唯一状态数据源 |
| 输入日志 | `.flow/input-log.md` | 关键输入记录模板 |
| 灵光收集箱 | `.flow/spark-box.md` | 灵光记录模板 |
| Pending Docs | `.flow/pending-docs.md` | 文档债务记录模板 |

### 2.4 辅助脚本

| 交付物 | 路径 | 说明 |
|--------|------|------|
| 状态查看 | `scripts/status.js` | 读取state.json输出摘要 |
| 格式校验 | `scripts/validate.js` | 校验.flow/文件格式 |
| 脚本入口 | `package.json` | npm scripts 定义 |

---

## 三、规范定义

> CLAUDE.md 采用"精简+详细"双文档结构，遵循业界最佳实践。

### 3.1 CLAUDE.md（精简版）内容规格

**设计原则**（基于业界最佳实践）：
- 长度 <100 行（业界建议 <300 行，最佳 <60 行）
- 只包含声明式指令，不包含说明性内容
- 每次对话都会加载，控制 token 消耗
- 详细规范用指针引用，不内联

**必须包含**：

| 内容 | 说明 |
|------|------|
| 核心命令 | `npm run status`、`npm run validate` |
| 状态文件列表 | state.json、input-log.md、spark-box.md、pending-docs.md |
| 流程阶段枚举 | 5个阶段的枚举值 |
| AI行为规则 | 始终做/绝不做/阶段引导（声明式要点） |
| 影响分析格式 | 输出模板 |
| 文件结构 | 项目目录结构 |
| 详细规范指针 | 指向 `docs/协作规范.md` |

### 3.2 协作规范.md（详细版）内容规格

**定位**：AI 按需读取的详细规范

**必须包含**：

| 章节 | 内容 |
|------|------|
| 核心理念 | 核心原则、解决的问题 |
| 流程全景 | 流程图、阶段说明、回退规则 |
| 核心机制详细定义 | 输入日志、灵光收集箱、流程上下文、影响分析、状态管理、Pending Docs、输出规范（共7个机制的完整定义） |
| 阶段详细规则 | 5个阶段的触发条件、AI行为、产出、完成标志 |
| 文件格式规格 | state.json 结构、各 md 文件格式 |
| AI引导示例 | 阶段不符时的引导示例 |

### 3.3 产出物规范内容规格

> 定义各类产出物"怎么写"的规范，AI按规范执行，人类按规范审核

**共同原则**：
- 迭代1为基础版本，后续根据实践反馈迭代优化
- 规范本身通过自举流程开发（需求→设计→实现）
- 按需加载：AI根据当前阶段/任务加载对应规范

**各规范内容要素**：

| 规范 | 负责角色 | 必须包含 |
|------|----------|----------|
| **需求文档规范** | 产品 | 迭代PRD结构模板、功能描述标准、验收标准编写指南、需求分类（功能/非功能） |
| **设计文档规范** | 架构/研发 | 设计文档结构模板、技术方案描述标准、接口定义格式、设计决策记录 |
| **研发规范** | 研发工程师 | 代码结构（目录/命名/模块）、代码风格、单元测试、集成测试 |
| **测试规范** | 测试工程师 | E2E测试、性能测试、破坏性测试、健壮测试 |

### 3.4 AI 行为准则（两文档共同遵守）

**始终做**：
- 维护流程上下文
- 捕获关键输入
- 灵光记录到收集箱
- 变更前影响分析
- 输出总分结构

**绝不做**：
- 需求阶段写代码
- 跳过影响分析直接执行
- 输出超认知负荷内容
- 丢失关键输入

---

## 四、文件格式规格

### 4.1 state.json 结构

```json
{
  "version": "2.0",
  "project": {
    "name": "string, 必填, 项目名称",
    "description": "string, 可选, 项目描述",
    "createdAt": "string, 必填, ISO日期"
  },
  "flow": {
    "phase": "string, 必填, 枚举: project_init | iteration_requirements | iteration_design | iteration_implementation | iteration_verification",
    "status": "string, 必填, 枚举: in_progress | pending_approval | approved | completed",
    "iteration": "number, 必填, 当前迭代号",
    "task": "string, 可选, 当前任务描述"
  },
  "iterations": [
    {
      "id": "number, 必填",
      "name": "string, 必填",
      "status": "string, 必填, 枚举: planning | in_progress | completed",
      "prd": "string, 可选, PRD文件路径"
    }
  ],
  "sparks": [
    {
      "id": "string, 必填",
      "content": "string, 必填",
      "createdAt": "string, 必填",
      "status": "string, 必填, 枚举: pending | processed"
    }
  ],
  "pendingDocs": [
    {
      "id": "string, 必填",
      "type": "string, 必填",
      "file": "string, 必填",
      "description": "string, 必填",
      "createdAt": "string, 必填"
    }
  ],
  "recentChanges": [
    {
      "date": "string, 必填",
      "change": "string, 必填"
    }
  ],
  "lastUpdated": "string, 必填, ISO日期时间"
}
```

**字段说明**：
- `flow.phase`：当前流程阶段
- `flow.status`：当前阶段的状态
- `sparks`：从 spark-box.md 同步的待处理灵光（便于脚本读取）
- `pendingDocs`：从 pending-docs.md 同步的待处理文档债务
- `recentChanges`：最近变更记录（最多保留10条）

### 4.2 input-log.md 格式

```markdown
# 输入日志

> 记录所有关键输入，保留决策依据

| 时间 | 类型 | 阶段 | 内容 | AI归纳 |
|------|------|------|------|--------|
| 12-17 10:00 | 需求 | 迭代1-需求 | "登录要支持微信" | 新增微信登录需求 |
```

**类型枚举**：需求 | 决策 | 反馈 | 变更

### 4.3 spark-box.md 格式

```markdown
# 灵光收集箱

> 捕获灵光一闪，不打断当前任务

## 待处理

- [ ] **2024-12-17**：以后要加支付功能
  - 来源：迭代1需求讨论时提到
  - 优先级：待定

## 已处理

- [x] **2024-12-16**：考虑支持多语言
  - 处理结果：记录到产品PRD路线图
```

### 4.4 pending-docs.md 格式

```markdown
# Pending Docs

> 追踪"实现先行"场景下的文档债务

## 待同步

| 时间 | 变更类型 | 涉及文件 | 变更内容 |
|------|----------|----------|----------|
| 12-17 | 接口变更 | auth模块 | 新增token参数 |

## 已同步

| 时间 | 变更类型 | 涉及文件 | 同步时间 |
|------|----------|----------|----------|
```

---

## 五、脚本规格

### 5.1 status.js

**功能**：读取 state.json，输出人类可读摘要

**输入**：无参数

**输出格式**：
```
=====================================
SoloDevFlow 状态摘要
=====================================

【当前位置】
  阶段: 迭代1-需求
  状态: 进行中
  任务: 编写迭代PRD

【待处理项】
  灵光: 2 条待处理
  Pending Docs: 0 条

【最近变更】
  - 12-17: 创建迭代1-PRD
  - 12-16: 项目初始化

=====================================
```

**退出码**：
- 0：成功
- 1：state.json 不存在或格式错误

### 5.2 validate.js

**功能**：校验 .flow/ 目录下文件格式

**输入**：无参数

**校验规则**：

| 文件 | 校验项 |
|------|--------|
| state.json | JSON语法正确、必填字段存在、枚举值合法 |
| input-log.md | 文件存在、表头正确 |
| spark-box.md | 文件存在、包含"待处理"和"已处理"章节 |
| pending-docs.md | 文件存在、包含"待同步"和"已同步"章节 |

**输出格式**：
```
SoloDevFlow 格式校验
-------------------------------------
[✓] state.json - OK
[✓] input-log.md - OK
[✓] spark-box.md - OK
[✓] pending-docs.md - OK
-------------------------------------
校验通过: 4/4
```

或（有错误时）：
```
SoloDevFlow 格式校验
-------------------------------------
[✓] state.json - OK
[✗] input-log.md - 缺少表头
[✓] spark-box.md - OK
[✗] pending-docs.md - 缺少"已同步"章节
-------------------------------------
校验通过: 2/4

错误详情:
1. input-log.md: 缺少表头 "| 时间 | 类型 | 阶段 | 内容 | AI归纳 |"
2. pending-docs.md: 缺少 "## 已同步" 章节
```

**退出码**：
- 0：全部通过
- 1：有校验失败

### 5.3 package.json scripts

```json
{
  "scripts": {
    "status": "node scripts/status.js",
    "validate": "node scripts/validate.js"
  }
}
```

---

## 六、验收标准

### 6.1 文档验收（人类审核）

| 验收项 | 验证方法 | 通过标准 |
|--------|----------|----------|
| CLAUDE.md 精简性 | 统计行数 | <100 行 |
| CLAUDE.md 完整性 | 对照 3.1 检查 | 包含所有必须项 |
| 协作规范.md 完整性 | 对照 3.2 检查 | 包含所有章节 |
| 产品PRD 完整性 | 检查文档结构 | 包含愿景、元原则、路线图 |
| 迭代1-PRD 完整性 | 检查本文档 | 交付物清单、规格、验收标准齐全 |

### 6.2 产出物规范验收（人类审核）

| 验收项 | 验证方法 | 通过标准 |
|--------|----------|----------|
| 需求文档规范 | 对照 3.3 检查 | 包含所有必须要素 |
| 设计文档规范 | 对照 3.3 检查 | 包含所有必须要素 |
| 研发规范 | 对照 3.3 检查 | 包含所有必须要素 |
| 测试规范 | 对照 3.3 检查 | 包含所有必须要素 |

### 6.3 模板验收（格式检查）

| 验收项 | 验证方法 | 通过标准 |
|--------|----------|----------|
| state.json | `npm run validate` | 校验通过 |
| input-log.md | `npm run validate` | 校验通过 |
| spark-box.md | `npm run validate` | 校验通过 |
| pending-docs.md | `npm run validate` | 校验通过 |

### 6.4 脚本验收（功能测试）

| 验收项 | 验证方法 | 通过标准 |
|--------|----------|----------|
| npm run status | 执行命令 | 输出符合 5.1 格式，退出码 0 |
| npm run validate | 执行命令 | 输出符合 5.2 格式，退出码 0 |
| 错误处理 | 故意破坏文件后执行 | 能检测出错误，给出明确提示 |

### 6.5 自举实验（过程记录）

**目的**：用迭代1流程完成迭代1开发，记录问题供迭代2改进

**实验内容**：
1. 按 CLAUDE.md 流程完成迭代1的设计和实现
2. 过程中记录所有"AI没按规范执行"的情况
3. 过程中记录所有"规范定义不清晰"的情况

**产出**：`.flow/自举实验记录.md`

**记录格式**：
```markdown
# 迭代1 自举实验记录

## AI行为偏差记录

| 时间 | 场景 | 预期行为 | 实际行为 | 可能原因 |
|------|------|----------|----------|----------|

## 规范改进建议

| 问题 | 建议改进 | 优先级 |
|------|----------|--------|
```

**验收标准**：
- 有记录文件（不要求内容为空）
- 记录格式正确
- **不设"零问题"要求**

---

## 七、不包含（明确排除）

以下内容**不在迭代1范围**：

| 排除项 | 原因 | 计划迭代 |
|--------|------|----------|
| AI行为一致性保证 | 需要工具强制 | 迭代2 |
| 自动影响分析 | 需要代码分析工具 | 迭代2 |
| 任务栈机制 | 迭代1单任务模式 | 迭代2 |
| history/ 归档 | 手动管理 | 迭代2 |
| Git hooks 集成 | 迭代1手动检查 | 迭代2 |

---

## 八、依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| Node.js | >=18 | 运行脚本 |
| Claude Code | 最新 | AI协作 |

---

## 九、文件结构

```
项目根目录/
├── CLAUDE.md                    # AI协作规范（精简版，<100行）
├── package.json                 # npm scripts
├── scripts/
│   ├── status.js               # 状态查看
│   └── validate.js             # 格式校验
├── docs/
│   ├── 产品PRD.md
│   ├── 协作规范.md              # 详细机制定义
│   ├── iterations/
│   │   └── 迭代1-PRD.md
│   └── specs/                   # 产出物规范
│       ├── 需求文档规范.md
│       ├── 设计文档规范.md
│       ├── 研发规范.md
│       └── 测试规范.md
└── .flow/
    ├── state.json              # 状态数据
    ├── input-log.md            # 输入日志
    ├── spark-box.md            # 灵光收集箱
    ├── pending-docs.md         # 文档债务
    └── 自举实验记录.md          # 自举实验产出
```

---

*版本：v2.4*
*更新时间：2024-12-20*
*v2.0 重构原因：明确区分"规范定义"与"代码交付"，设定诚实的验收预期*
*v2.1 更新：移除 status.md 相关内容，state.json 为唯一状态源*
*v2.2 更新：CLAUDE.md 拆分为精简版+详细版（协作规范.md），遵循业界最佳实践*
*v2.3 更新：新增产出物规范（需求/设计/代码结构/代码实现/测试规范）作为交付物*
*v2.4 更新：规范体系调整为4个（需求文档/设计文档/研发/测试），区分研发工程师和测试工程师职责*
