# 迭代1 - PRD

> 核心流程手动可用

---

## 一、迭代目标

**让核心流程跑通**：通过 CLAUDE.md 规范 + 基础 npm scripts，实现人机协作的核心闭环。

**自举验证**：用此流程完成迭代1本身的开发。

---

## 二、功能范围

### 2.1 输入日志机制

**目的**：捕获人类所有关键输入，不丢失决策依据

**功能**：
- AI 判断输入是否为"关键输入"（影响产品方向、设计决策、功能定义）
- 关键输入记录到 `.flow/input-log.md`
- 记录格式：时间、原文、类型、阶段、AI归纳

**判断规则**（来自产品PRD）：
| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 关键输入 | 影响产品方向、设计决策、功能定义 | "登录要支持微信"、"这个方案不行" |
| 普通对话 | 确认、闲聊、操作指令 | "好的"、"继续"、"帮我看看这个文件" |

**验收标准**：
- [ ] 人类的需求/决策/反馈/变更被记录到 input-log.md
- [ ] 可追溯任何决策的原始依据

---

### 2.2 灵光收集箱

**目的**：捕获灵光一闪，不打断当前流程

**功能**：
- AI 识别"灵光"（与当前迭代/任务无直接关联的想法）
- 记录到 `.flow/spark-box.md`
- 告知人类已记录，继续当前任务
- 阶段结束时回顾待处理灵光

**判断规则**（来自产品PRD）：
| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 灵光 | 与当前迭代/任务无直接关联 | 正在做登录，突然说"以后要加支付" |
| 任务延伸 | 当前任务的细化、补充、调整 | 正在做登录，说"登录后要跳转到首页" |

**验收标准**：
- [ ] 灵光不打断当前任务
- [ ] 灵光被记录到 spark-box.md
- [ ] 阶段结束时 AI 主动提醒处理待处理灵光

---

### 2.3 流程上下文

**目的**：AI 始终知道当前阶段，主动引导而非被动响应

**功能**：
- AI 维护当前阶段（项目启动 / 迭代X-需求 / 迭代X-设计 / 迭代X-实现 / 迭代X-验证）
- 人类输入与阶段不符时，AI 主动引导
- 提供切换选项：立即处理 or 记录灵光

**判断规则**（来自产品PRD）：
| 类型 | 判断标准 | 示例 |
|------|----------|------|
| 符合阶段 | 请求属于当前阶段的正常产出 | 需求阶段讨论功能范围 |
| 不符合阶段 | 请求属于其他阶段的产出 | 需求阶段要求写代码 |

**AI 引导示例**：
```
人类："我想改一下登录的逻辑"

AI："当前在【迭代1-需求】阶段。
    你说的是修改登录逻辑，这涉及实现阶段的工作。
    按流程应该：1.完成需求 → 2.设计 → 3.再实现

    选择：
    A) 记录到灵光收集箱，继续当前需求分析
    B) 切换到实现阶段处理这个变更"
```

**验收标准**：
- [ ] AI 能说出"当前在XX阶段"
- [ ] AI 不直接响应字面需求，先判断是否符合阶段
- [ ] 不符合时提供明确的引导和选项

---

### 2.4 状态管理

**目的**：人类可读 + AI 可用，跨 Session 状态连续

**功能**：
- 唯一数据源：`.flow/state.json`
- IDE 中节点可折叠，结构清晰
- 迭代1 不引入 status.md，避免双文件同步负担
- AI 每次对话开始时主动读取 state.json 恢复状态

**state.json 结构**：
```json
{
  "project": {
    "name": "SoloDevFlow 2.0",
    "currentPhase": "迭代1-设计"
  },
  "currentIteration": {
    "id": 1,
    "stage": "设计",
    "currentTask": "编写迭代1-PRD"
  },
  "pendingDocs": [],
  "sparkBox": {
    "unprocessedCount": 0
  },
  "lastUpdated": "2024-12-17T10:00:00Z"
}
```

**验收标准**：
- [ ] 人类在 IDE 中查看 state.json 能快速了解全局（节点折叠）
- [ ] AI 能读写 state.json 获取和更新状态
- [ ] 新 Session 时 AI 读取 state.json 后能继续工作

---

### 2.5 Pending Docs 机制

**目的**：允许暂时打破"先文档后代码"规则，但提交前必须还债

**适用场景**（来自产品PRD）：
| 场景 | 说明 | 示例 |
|------|------|------|
| **实现倒逼设计** | 编码时发现必须修改接口/数据结构才能跑通 | "这个接口必须加 token 参数才能鉴权" |
| **快速热修复** | 通过对话直接修改代码细节，未先行修改文档 | "把默认值改成 10" |

**功能**：
- 人类允许 AI 先改代码时，记录变更到 `.flow/pending-docs.md`
- Git Commit 前，AI 主动提醒处理 pending docs
- AI 根据 pending-docs 反向更新文档后清空

**验收标准**：
- [ ] pending-docs.md 能记录待同步的文档变更
- [ ] AI 在 Commit 前主动提醒："有 N 条 pending docs 待处理"
- [ ] 处理完成后 pending-docs.md 被清空

---

### 2.6 AI 主动索取上下文

**目的**：减轻人类"投喂文档"的负担

**功能**：
- AI 修改模块代码前，主动检查是否已了解相关设计文档
- 如果没有，主动询问是否需要加载
- 变"人主动投喂"为"AI主动索取"

**AI 行为示例**：
```
AI："我准备开始修改 auth 模块的代码。
    我需要先了解该模块的设计文档。
    请问是否需要我读取 docs/modules/auth.md？"
```

**验收标准**：
- [ ] AI 修改代码前主动询问是否需要加载相关文档
- [ ] 不等人类想起来才投喂

---

### 2.7 基础 npm scripts（针对 AI 调用优化）

**设计原则**：
- **读操作**：可以用脚本，帮助 AI 快速获取聚合信息（省 Token）
- **写操作**：废弃脚本，AI 用原生文件编辑能力直接操作（避免转义地狱）

**为什么不用脚本做写操作**：
- AI 通过 Shell 调用脚本处理复杂字符串容易出错（引号、换行、特殊字符）
- Claude Code 原生就有文件读写能力，用脚本是能力降级
- LLM 擅长生成 Markdown，直接编辑文件更自然

**脚本清单**：

| 脚本 | 功能 | 目的（AI视角） |
|------|------|----------------|
| `npm run status` | 读取 state.json 并输出精简摘要 | AI 启动时快速确认"我在哪"，省 Token |
| `npm run validate` | 检查 .flow/ 下文件格式一致性 | AI 修改状态后自检，确保没写坏 |

**废弃的脚本**（AI 直接操作文件）：
- ~~`npm run log`~~ → AI 直接编辑 input-log.md
- ~~`npm run spark`~~ → AI 直接编辑 spark-box.md
- ~~`npm run context`~~ → AI 直接读取 state.json

**验收标准**：
- [ ] `npm run status` 输出当前阶段、进度概览、pending docs 数量
- [ ] `npm run validate` 检查 state.json 格式正确性

---

### 2.8 文件操作格式规范

**目的**：让 AI 用原生文件编辑能力直接操作，无需脚本中转

**设计原则**：
- 模板定义在 `.flow/` 下的实际文件中（项目初始化时创建）
- CLAUDE.md 只说"读取文件，按现有格式操作"
- AI 操作时读取文件自然获得格式，符合"按需加载"原则

**初始化模板**（项目启动时创建）：

`.flow/input-log.md`：
```markdown
# 输入日志

| 时间 | 类型 | 阶段 | 内容 | AI归纳 |
|------|------|------|------|--------|
```

`.flow/spark-box.md`：
```markdown
# 灵光收集箱

## 待处理

## 已处理
```

`.flow/pending-docs.md`：
```markdown
# Pending Docs

## 待同步
| 时间 | 变更类型 | 涉及文件 | 变更内容 |
|------|----------|----------|----------|

## 已同步
```

**AI 操作规范**：
- 记录输入日志：读取 input-log.md，按现有格式在表格末尾追加新行
- 记录灵光：读取 spark-box.md，在"待处理"下追加新条目
- 记录 pending docs：读取 pending-docs.md，在"待同步"表格追加
- **禁止**使用 npm scripts 做写操作

**验收标准**：
- [x] 模板从 CLAUDE.md 移至实际文件（v0.5 按需加载）
- [ ] 项目初始化时创建带格式的空模板文件
- [ ] AI 能按格式直接编辑这些文件

---

## 三、文件结构

```
项目根目录/
├── CLAUDE.md                    # AI 协作规范（含文件操作格式定义）
├── package.json                 # npm scripts 定义
├── scripts/                     # 工具脚本（仅读操作）
│   ├── status.js                # 状态摘要输出
│   └── validate.js              # 格式校验
├── docs/
│   ├── 产品PRD.md
│   └── iterations/
│       └── 迭代1-PRD.md
└── .flow/                       # 流程状态（AI 直接读写）
    ├── state.json               # 唯一状态数据源
    ├── input-log.md             # 输入日志
    ├── spark-box.md             # 灵光收集箱
    └── pending-docs.md          # 待同步文档记录
```

---

## 四、关于流程文档的裁剪说明

根据《产品PRD》元原则1，流程文档是"产品级必须文档"。但在迭代1阶段做如下裁剪：

**决策**：暂不创建独立的《流程文档》

**理由**：
- 迭代1处于系统自举阶段，业务逻辑单一（开发系统本身）
- 避免过度设计（YAGNI原则）

**替代方案**：
- 所有原属于《流程文档》定义的"横向功能规范"（日志格式、JSON结构）和"协作流程"，均直接在 **CLAUDE.md** 中定义
- CLAUDE.md 暂时承载流程文档的全部职能

**迭代1结束时的交付物**：
- 迭代1-PRD 中定义的格式规范（2.8章节），需迁移到 CLAUDE.md 持久化
- 需求文档会归档，规范需要持久化

**演进计划**：
- 迭代2+引入复杂业务模块时，再将相关规则从 CLAUDE.md 剥离至独立的《流程文档》

---

## 五、AI 内置行为（非独立功能模块）

以下能力依赖 AI 本身的能力 + CLAUDE.md 规范约束，不作为独立功能模块实现：

### 5.1 影响分析（手动版）

**定位**：AI 内置行为规范，不是待实现功能

**迭代1实现方式**：
- AI 利用自身能力分析变更影响
- 按 CLAUDE.md 规范输出影响报告
- 人类审批后再执行

**触发条件**：需求/设计变更时

**输出格式**：
```
【变更】：xxx
【直接影响】：
  - 文档A：需要更新xxx
  - 代码B：需要修改xxx
【间接影响】：
  - 模块C：因为依赖A，需要检查xxx
【建议操作顺序】：1→2→3
```

**局限性**（来自产品PRD）：
- 隐式依赖难以发现
- 跨模块副作用可能漏判
- 需配合测试验证

**迭代2+演进**：引入自动影响分析工具（静态代码分析等）

### 5.2 阶段回退（手动版）

**定位**：AI 引导 + 人类决策，不是自动化功能

**迭代1实现方式**：
- AI 识别回退需求，引导人类确认
- 人类决定是否回退
- AI 更新 state.json 中的阶段状态
- AI 记录回退原因到输入日志

**迭代2+演进**：引入脚本辅助回退

---

## 六、不包含（迭代2+）

- 复杂的 IDE 插件
- 全自动化的 CI/CD 流水线
- status.md 自动生成（迭代1 只用 state.json）
- 静态代码分析工具集成
- 横向功能的接口抽象（迭代1 用最简单实现，遵循 YAGNI）
- 独立的流程文档（迭代1 由 CLAUDE.md 承载）
- 任务栈机制（迭代1 为单任务模式）
- 自动变更传播（迭代1 为手动影响分析）
- 模块级状态（迭代1 为迭代级状态）
- 分批处理规则（迭代1 为人工控制）
- history/ 历史归档（迭代1 手动管理）

---

## 七、依赖

- Node.js（运行 npm scripts）
- Claude Code（AI 协作）

---

## 八、验收标准（整体）

### 可执行验收清单

**验收方式说明**：
- 🤖 **AI脚本验收**：AI 执行脚本，人类查看结果
- 👤 **人类手动验收**：人类操作触发，观察 AI 行为
- 📋 **人类检查验收**：人类直接查看文件/状态

| 验收项 | 方式 | 验证方法 | 通过标准 |
|--------|------|----------|----------|
| 自举验证 | 📋 | 完成迭代1开发 | 迭代1功能全部实现 |
| 输入日志 | 📋 | 检查 `.flow/input-log.md` | 至少包含 5 条关键决策记录，格式正确 |
| 灵光收集 | 📋 | 检查 `.flow/spark-box.md` | 有灵光记录，阶段结束时已处理或标记 |
| 流程引导 | 👤 | 在需求阶段要求写代码（测试5次） | 至少4次AI正确识别并引导 |
| 影响分析 | 👤 | 提出需求变更 | AI 先输出影响报告，人类确认后再执行 |
| 阶段回退 | 👤 | 在设计阶段说"需求有问题" | AI 引导回退，更新状态，记录原因 |
| 状态可读 | 📋 | IDE 打开 `.flow/state.json` | 节点可折叠，结构清晰 |
| 跨Session | 👤 | 新会话让 AI 读取 state.json | AI 能说出当前阶段并继续工作 |
| Pending Docs | 👤 | Commit 前询问 AI | AI 主动提醒处理 pending docs |
| 文件直接编辑 | 👤 | 让 AI 记录输入/灵光 | AI 直接编辑 Markdown，不调用脚本 |
| npm scripts | 🤖 | `npm run status` 和 `npm run validate` | 输出符合预期，无报错 |

### AI 可执行测试

```bash
# 状态查看（脚本）
npm run status
# 预期：输出当前阶段、进度概览、pending docs 数量

# 格式校验（脚本）
npm run validate
# 预期：检查 state.json 格式，输出 OK 或错误信息
```

### AI 文件操作测试（直接编辑，不用脚本）

```
测试1：记录输入日志
- AI 读取 .flow/input-log.md
- 在表格末尾追加新行
- 验证：格式符合规范

测试2：记录灵光
- AI 读取 .flow/spark-box.md
- 在"待处理"下追加条目
- 验证：格式符合规范

测试3：记录 pending docs
- AI 读取 .flow/pending-docs.md
- 在"待同步"表格追加
- 验证：格式符合规范
```

### 量化指标（可验证版）

| 指标 | 验证方法 | 通过标准 |
|------|----------|----------|
| 关键输入记录 | 📋 迭代结束时检查 input-log.md | 至少包含 5 条关键决策记录 |
| 灵光处理 | 📋 迭代结束时检查 spark-box.md | 无超过1个迭代未处理的灵光 |
| AI 阶段引导 | 👤 进行 5 次跨阶段请求测试 | 至少 4 次 AI 正确识别并引导 |

---

*版本：v1.6*
*创建时间：2024-12-17*
*基于：产品PRD v0.8*
*更新内容：v1.1 重构 npm scripts 设计，新增文件操作格式规范；v1.2 新增流程文档裁剪说明（CLAUDE.md 暂代）；v1.3 新增第五章"AI内置行为"（影响分析、阶段回退），明确迭代1不包含的目标架构功能；v1.4 验收标准改进：区分验收方式（🤖AI脚本/👤人类手动/📋人类检查），量化指标改为具体可验证数量；v1.5 文件格式模板已迁移至 CLAUDE.md v0.4；v1.6 改为"按需加载"：模板定义在实际文件中，CLAUDE.md只说"读取文件按格式操作"*
