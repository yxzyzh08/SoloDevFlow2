# 工作流程框架设计评估计划

## 1. 用户设计概述

用户提出的新工作流程框架：

```
基本流程：每次接受输入 → 分析输入流程

分析输入流程：
  Step 1: 判断输入类型（咨询/需求/咨询+需求）
  Step 2: 咨询+需求 → 需求存入临时列表 → 进入咨询流程
  Step 3: 纯咨询 → 进入咨询流程
  Step 4: 纯需求 → 进入需求流程

咨询交付流程：
  Step 1: 加载PRD → 查询关联的feature/flow/capability → 回答问题
```

## 2. 用户提出的关键问题

1. **咨询结束判断**：怎么确认咨询交付流程结束，才能处理临时需求？
2. **跨对话上下文**：每次对话都是新的，但可能谈论同一件事，设计能否实现？

## 3. 现有系统分析

### 3.1 已有的意图识别（flow-workflows.md 6.1）

| 意图类型 | 说明 | 现有处理 |
|----------|------|----------|
| 需求交付 | 描述功能需求 | → 需求交付流程 |
| 功能咨询 | 询问现有功能 | → 功能咨询流程 |
| 变更请求 | 修改规范/PRD | → 变更影响流程 |
| 灵光想法 | 与当前任务无关 | → 灵光处理流程 |

**缺失的部分**：
- ❌ 没有"咨询+需求"混合类型的处理
- ❌ 没有"临时需求列表"的概念
- ❌ 没有"会话模式"的状态管理

### 3.2 现有状态管理（state.json）

```json
{
  "flow": {
    "researchMethod": "bottom-up",
    "activeFeatures": ["project-init"]
  },
  "features": { ... },
  "sparks": [],           // 灵光收集
  "pendingDocs": []       // 文档债务
}
```

**可复用机制**：
- `sparks` 机制可以扩展为"临时需求"存储
- 状态持久化通过 state.json 实现

## 4. 可行性评估

### 4.1 技术可行性：✅ 完全可行

Claude Code/CLI 的能力边界：
- ✅ **输入分类能力**：AI 可以判断输入是咨询、需求还是混合
- ✅ **状态持久化**：通过 state.json 跨对话保持状态
- ✅ **文档加载**：已有机制加载 PRD 和关联文档
- ✅ **多步骤流程**：已有完整的流程执行框架

### 4.2 需要解决的核心问题

#### 问题1：咨询结束判断

**三种策略**：

| 策略 | 实现方式 | 优点 | 缺点 |
|------|----------|------|------|
| 显式结束 | 用户说"咨询完了" | 清晰、无歧义 | 需要用户记得说 |
| 隐式结束 | 用户开始描述需求 | 自然流畅 | 可能误判 |
| AI 主动询问 | 回答后问"还有问题吗？" | 确保不遗漏 | 可能打断思路 |

**推荐方案：隐式结束 + 定期提醒**
- 每次咨询回答后，检测是否有临时需求待处理
- 如果有，在回答末尾附加提示："[有 N 条临时需求待处理，说'处理需求'开始]"

#### 问题2：跨对话上下文

**现状**：每次对话是新的会话，但 state.json 可以持久化状态

**解决方案：扩展 state.json**

```json
{
  "session": {
    "mode": "idle | consulting | delivering",
    "context": {
      "topic": "当前咨询/需求的主题",
      "relatedFeatures": ["feature1"],
      "pendingRequirements": [
        {
          "id": "req-001",
          "content": "需求描述",
          "capturedAt": "2024-12-24T10:00:00Z",
          "source": "咨询过程中提取"
        }
      ]
    }
  }
}
```

## 5. 设计建议

### 5.1 输入分析流程（增强版）

```
[用户输入]
    ↓
[意图识别] → 是否包含咨询成分？
    ↓
   ┌─────────────────┬─────────────────┬─────────────────┐
   ↓                 ↓                 ↓                 ↓
 纯咨询          咨询+需求           纯需求           其他类型
   ↓                 ↓                 ↓                 ↓
 咨询流程      提取需求→临时列表   需求交付流程    现有流程处理
                    ↓
               咨询流程
```

### 5.2 咨询交付流程（详细设计）

```
[用户咨询问题]
    ↓
[加载 PRD]
    ↓
[识别关联的 Feature/Flow/Capability]
    ↓
[加载相关文档] ← 通过 state.json 的 docPath 定位
    ↓
[生成回答]
    ↓
[检查是否有临时需求]
    ↓
 ┌─ 有 → 附加提示："[N 条临时需求待处理]"
 └─ 无 → 等待下一个输入
```

### 5.3 临时需求管理

**选项 A：复用 sparks 机制**
- 优点：不需要新增字段，机制已存在
- 缺点：语义不同（sparks = 灵光，临时需求 = 延迟处理的正式需求）

**选项 B：新增 pendingRequirements 字段**
- 优点：语义清晰，独立管理
- 缺点：需要修改 state.json schema

**推荐：选项 B**

### 5.4 与现有系统的整合

| 现有流程 | 整合方式 |
|----------|----------|
| 功能咨询流程（6.2.4） | 扩展为新的咨询交付流程 |
| 需求交付流程（6.2.2） | 保持不变，增加"从临时需求开始"的入口 |
| 灵光处理流程（6.2.6） | 保持不变，灵光 vs 临时需求是不同概念 |

## 6. 实现步骤

### Phase 1：状态扩展
1. 设计 state.json 新增的 `session` 字段 schema
2. 更新 validate-state.js 支持新字段
3. 更新 state.js CLI 支持会话状态查询/更新

### Phase 2：意图识别增强
1. 更新 flow-workflows.md 的意图识别规则
2. 增加"咨询+需求"混合类型的处理逻辑
3. 定义临时需求提取的规则

### Phase 3：咨询交付流程
1. 编写新的咨询交付流程执行规范
2. 定义 PRD → Feature/Flow/Capability 的查询机制
3. 实现"咨询结束+临时需求处理"的状态转换

### Phase 4：需求交付流程增强
1. 增加"从临时需求开始"的入口
2. 更新需求交付流程，支持批量处理临时需求

## 7. 关键决策点（需要用户确认）

1. **临时需求存储**：使用 sparks 机制还是新增字段？
2. **咨询结束判断**：显式、隐式还是 AI 主动询问？
3. **临时需求处理时机**：咨询结束后自动触发，还是用户显式请求？

## 8. 结论

**设计可行性：✅ 完全可行**

基于 Claude Code 当前能力：
- state.json 可以持久化所有需要的状态
- AI 的意图识别能力足以区分咨询/需求/混合类型
- 现有的流程框架可以扩展支持新的交互模式

**核心改动点**：
1. state.json schema 扩展（新增 session 字段）
2. 意图识别规则增强（增加混合类型）
3. 咨询交付流程规范化
4. 临时需求管理机制

---

*Plan created: 2024-12-24*
